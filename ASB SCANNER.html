<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ASB Scanner â€” Binance/MEXC â€¢ IST â€¢ Admin PRO</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --panel2:#0d1628;
    --muted:#9fb0d4; --text:#e8eefc; --border:#22304a;
    --accent:#5eead4; --ok:#9ae6b4; --warn:#ffd166; --danger:#ff6b6b;
    --chip:#12203a;
  }
  html,body{height:100%}
  body{
    margin:0;
    background:radial-gradient(1200px 600px at 10% -10%,#0d1a30 0,#0b1220 40%,#0a1020 100%);
    color:var(--text);
    font:14px system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  *{box-sizing:border-box}
  .wrap{max-width:1320px;margin:22px auto;padding:0 14px}
  .panel{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
  .col{display:flex;flex-direction:column;gap:6px;min-width:160px}
  h2{font-weight:700;letter-spacing:.2px;margin:0}
  label{font-size:12px;color:var(--muted)}
  input,select,button{
    background:#0c1426;color:var(--text);
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px 10px;min-height:36px;outline:none;
  }
  input:focus,select:focus{border-color:#355080;box-shadow:0 0 0 3px rgba(53,80,128,.22)}
  button{cursor:pointer}
  .btn{
    background:linear-gradient(90deg,#1b2a44,#17354a);
    border-color:#2b3b5a;
    box-shadow:0 6px 16px rgba(0,0,0,.25)
  }
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .pill{
    padding:4px 8px;border-radius:999px;border:1px solid var(--border);
    font-size:12px;display:inline-flex;align-items:center;gap:6px;background:var(--chip)
  }
  .pill.ok{background:rgba(16,61,39,.55);border-color:#2b6b46;color:#9ae6b4}
  .pill.bad{background:rgba(61,16,16,.55);border-color:#6b2b2b;color:#ff7b7b}
  .pill.warn{background:rgba(61,49,16,.55);border-color:#6b5a2b;color:#ffd166}
  .note{color:var(--muted);font-size:12px}
  .stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .stat{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0c1426}
  .grid{margin-top:12px;border:1px solid var(--border);border-radius:18px;overflow:auto;height:56vh}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{
    position:sticky;top:0;
    background:linear-gradient(180deg,#111b2e,#0f172a);
    border-bottom:1px solid var(--border);
    z-index:2;font-weight:700;color:#cbd5f1;
  }
  th,td{padding:10px;text-align:right;white-space:nowrap}
  th:first-child,td:first-child{text-align:left}
  tbody tr:nth-child(odd){background:#0c1426}
  tbody tr:hover{background:#0e1830}
  thead th[data-k]{cursor:pointer;user-select:none;position:relative}
  thead th[data-k]::after{
    content:"";position:absolute;right:8px;top:50%;
    width:8px;height:8px;border-right:2px solid #6aa7a0;border-bottom:2px solid #6aa7a0;
    opacity:.35;transform:translateY(-50%) rotate(-45deg)
  }
  thead th.sort-asc::after{opacity:.9;transform:translateY(-50%) rotate(-135deg)}
  thead th.sort-desc::after{opacity:.9;transform:translateY(-50%) rotate(45deg)}
  .bar{width:120px;height:8px;border-radius:999px;background:#0c1426;border:1px solid var(--border);position:relative;display:inline-block;overflow:hidden}
  .bar>i{position:absolute;top:-3px;width:2px;height:14px;background:#6dd6c8;border-radius:1px}
  .bar .lo{left:0}.bar .hi{right:0}.bar .p{background:var(--ok)}
  .trade-btn{
    display:inline-flex;align-items:center;justify-content:center;
    padding:7px 10px;border-radius:12px;
    border:1px solid rgba(94,234,212,.55);
    background:rgba(94,234,212,.10);
    color:var(--text); text-decoration:none; font-size:12px;
  }
  .trade-btn:hover{border-color:rgba(94,234,212,.85); background:rgba(94,234,212,.16)}
  .hidden{display:none !important}
  .errbox{
    margin-top:10px;
    border:1px solid #6b2b2b;
    background:rgba(61,16,16,.35);
    padding:10px;border-radius:14px;
    color:#ffd6d6;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="panel">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2>ASB Scanner <span class="note">â€” Binance works instantly â€¢ MEXC needs Proxy</span></h2>
      <div class="row" style="align-items:center">
        <a class="trade-btn" href="https://promote.mexc.co/r/5S4fzXCz" target="_blank" rel="noopener noreferrer">Join MEXC (Referral)</a>
        <button id="btnRefresh" class="btn">Refresh</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>Exchange</label>
        <select id="exchange">
          <option value="binance" selected>Binance (Spot)</option>
          <option value="mexc">MEXC (Spot) â€” needs proxy</option>
        </select>
      </div>

      <div class="col">
        <label>Proxy (ONLY for MEXC)</label>
        <input id="proxy" placeholder='Example: https://your-proxy/?url={url}'>
      </div>

      <div class="col"><label>Target Date (IST)</label><input type="date" id="date"></div>
      <div class="col"><label>Target Time (IST)</label><input type="time" id="timeIst" step="60"></div>

      <div class="col">
        <label>Timeframe candle</label>
        <select id="tf">
          <option value="auto" selected>Auto (fast: 1D)</option>
          <option value="15m">15m</option>
          <option value="30m">30m</option>
          <option value="1h">1h</option>
          <option value="2h">2h</option>
          <option value="4h">4h</option>
          <option value="6h">6h</option>
          <option value="12h">12h</option>
          <option value="1d">1d</option>
        </select>
      </div>

      <div class="col">
        <label>Top N (FREE)</label>
        <select id="topnFree">
          <option>20</option>
          <option selected>60</option>
          <option>100</option>
        </select>
      </div>

      <div class="col" id="topnProWrap">
        <label>Top N (PRO)</label>
        <select id="topnPro">
          <option>150</option>
          <option>200</option>
          <option>300</option>
          <option>500</option>
        </select>
      </div>

      <div class="col"><label>Near threshold (%)</label><input type="number" id="thr" value="0.25" step="0.01" min="0"></div>
      <div class="col"><label>Quick search</label><input id="search" placeholder="BTC, ETH, PEPEâ€¦"></div>

      <div class="col"><label> </label><button id="btnLoad" class="btn">Load Top</button></div>
      <div class="col"><label> </label><button id="btnExport" class="btn">Export CSV (PRO)</button></div>
    </div>

    <div class="row" style="margin-top:10px;align-items:center;justify-content:space-between">
      <div class="row" style="align-items:center;gap:10px">
        <span class="pill bad" id="adminPill">Admin: <b>Locked</b></span>
        <label class="pill"><input id="proToggle" type="checkbox" style="accent-color:#4fd1c5"> Enable PRO</label>
      </div>

      <div class="row" style="align-items:center;gap:8px">
        <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="Admin PIN" style="width:140px">
        <button id="btnUnlock" class="btn">Unlock</button>
        <button id="btnLock" class="btn">Lock</button>
      </div>
    </div>

    <div class="stats">
      <span class="stat">Rows: <strong id="rowCount">0</strong></span>
      <span class="stat">Mode: <strong id="modeTxt">FREE</strong></span>
      <span class="stat">Status: <strong id="statusTxt">Idle</strong></span>
    </div>

    <div id="err" class="errbox hidden"></div>

    <p class="note" style="margin-top:10px">
      If you choose <b>MEXC</b> and it shows an error: MEXC blocks browser calls (CORS). Use a proxy in the Proxy box.
      Binance usually works without proxy.
    </p>
  </div>

  <div class="grid">
    <table>
      <thead>
        <tr>
          <th data-k="symbol">Symbol</th>
          <th data-k="price">Live</th>
          <th data-k="high">High</th>
          <th data-k="low">Low</th>
          <th data-k="rangePct">%(Hiâ†”Low)</th>
          <th data-k="toHighPct">% to High</th>
          <th data-k="toLowPct">% to Low</th>
          <th data-k="closeness">Closeness</th>
          <th data-k="posPct">Pos%</th>
          <th>Proximity</th>
          <th>Trade</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="11" class="note">Click <b>Load Top</b> to start.</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
(() => {
  /******** ADMIN ********/
  const ADMIN_PIN = "9505";
  const ADMIN_KEY = "asb_admin";
  const PRO_KEY = "asb_pro";

  /******** DOM ********/
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  const exchangeSel = $("#exchange");
  const proxyInp = $("#proxy");
  const dateInp = $("#date");
  const timeInp = $("#timeIst");
  const tfSel = $("#tf");
  const topFreeSel = $("#topnFree");
  const topProSel = $("#topnPro");
  const topnProWrap = $("#topnProWrap");
  const thrInp = $("#thr");
  const searchInp = $("#search");
  const tbody = $("#tbody");

  const adminPill = $("#adminPill");
  const modeTxt = $("#modeTxt");
  const statusTxt = $("#statusTxt");
  const rowCount = $("#rowCount");
  const errBox = $("#err");

  const btnLoad = $("#btnLoad");
  const btnRefresh = $("#btnRefresh");
  const btnExport = $("#btnExport");
  const proToggle = $("#proToggle");
  const pinInp = $("#pin");
  const btnUnlock = $("#btnUnlock");
  const btnLock = $("#btnLock");

  /******** UTIL ********/
  const isF = (x) => Number.isFinite(x);
  const NF = new Intl.NumberFormat(undefined, { maximumFractionDigits: 8 });
  const NF2 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
  const fmt = (x) => isF(x) ? NF.format(x) : "â€”";
  const fmtPct = (x) => isF(x) ? (NF2.format(x) + "%") : "â€”";
  const fmt2 = (x) => isF(x) ? NF2.format(x) : "â€”";

  function setStatus(s){ statusTxt.textContent = s; }
  function showErr(msg){
    errBox.textContent = msg;
    errBox.classList.remove("hidden");
  }
  function clearErr(){
    errBox.textContent = "";
    errBox.classList.add("hidden");
  }

  async function fetchJson(url, timeoutMs=12000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, { signal: ctrl.signal });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    } finally {
      clearTimeout(t);
    }
  }

  function applyProxy(rawUrl){
    const p = (proxyInp.value || "").trim();
    if(!p) return rawUrl;
    // If proxy contains {url}, replace it. Else append ?url=
    if(p.includes("{url}")) return p.replaceAll("{url}", encodeURIComponent(rawUrl));
    const join = p.includes("?") ? "&" : "?";
    return p + join + "url=" + encodeURIComponent(rawUrl);
  }

  /******** IST TIME ********/
  const IST_OFFSET_MS = 5.5 * 3600e3;
  function parseYMD(s){ const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s||""); return m?{y:+m[1],mo:+m[2],d:+m[3]}:null; }
  function parseHM(s){ const m=/^(\d{1,2}):(\d{2})$/.exec(s||""); return m?{hh:Math.min(23,Math.max(0,+m[1])),mm:Math.min(59,Math.max(0,+m[2]))}:null; }
  function istDayStartUtcMs(istDateStr){
    const p=parseYMD(istDateStr); if(!p) return NaN;
    return Date.UTC(p.y,p.mo-1,p.d,0,0,0,0) - IST_OFFSET_MS;
  }
  function istDateTimeToUtcMs(istDateStr, istTimeStr){
    const p=parseYMD(istDateStr), t=parseHM(istTimeStr);
    if(!p||!t) return NaN;
    return Date.UTC(p.y,p.mo-1,p.d,t.hh,t.mm,0,0) - IST_OFFSET_MS;
  }
  function utcWindowForIst(istDateStr, istTimeStr){
    const start = istDayStartUtcMs(istDateStr);
    const last  = start + 24*3600e3 - 1;
    if(!istTimeStr) return {start, end:last};
    let end = istDateTimeToUtcMs(istDateStr, istTimeStr);
    if(!isF(end)) end = last;
    if(end < start) end = start;
    if(end > last) end = last;
    return {start, end};
  }

  const intervalMsMap = {
    "15m":900e3,"30m":1800e3,"1h":3600e3,"2h":7200e3,"4h":14400e3,"6h":21600e3,"12h":43200e3,"1d":86400e3
  };

  function compute(price, high, low){
    const r={toHighPct:null,toLowPct:null,posPct:null,closeness:null,rangePct:null};
    if(!(isF(price)&&isF(high)&&isF(low))) return r;
    const range=high-low; if(!(range>0)) return r;
    const toH=((high-price)/high)*100;
    const toL=((price-low)/low)*100;
    const pos=((price-low)/range)*100;
    r.toHighPct=toH; r.toLowPct=toL; r.posPct=pos;
    r.rangePct=((high/low)-1)*100;
    r.closeness=Math.min(Math.max(toH,0), Math.max(toL,0));
    return r;
  }

  function proxBar(posPct){
    if(!isF(posPct)) return "";
    const clamped = Math.max(0, Math.min(100, posPct));
    const px = (clamped/100)*118;
    return `<span class="bar"><i class="lo"></i><i class="hi"></i><i class="p" style="left:${px}px"></i></span>`;
  }

  /******** SECURITY STATE (BASIC) ********/
  function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === "1"; }
  function isPro(){ return localStorage.getItem(PRO_KEY) === "1"; }

  function setAdmin(v){
    localStorage.setItem(ADMIN_KEY, v ? "1" : "0");
    if(!v) localStorage.setItem(PRO_KEY, "0");
    refreshUI();
  }
  function setPro(v){
    if(!isAdmin()) { localStorage.setItem(PRO_KEY,"0"); refreshUI(); return; }
    localStorage.setItem(PRO_KEY, v ? "1" : "0");
    refreshUI();
  }

  function refreshUI(){
    const admin = isAdmin();
    const pro = isPro();

    adminPill.classList.remove("ok","bad");
    adminPill.classList.add(admin ? "ok" : "bad");
    adminPill.innerHTML = admin ? `Admin: <b>Unlocked</b>` : `Admin: <b>Locked</b>`;

    topnProWrap.classList.toggle("hidden", !admin);
    proToggle.checked = pro;
    btnExport.disabled = !(admin && pro);

    modeTxt.textContent = (admin && pro) ? "PRO" : "FREE";
  }

  btnUnlock.addEventListener("click", () => {
    const pin = (pinInp.value || "").trim();
    pinInp.value = "";
    if(pin === ADMIN_PIN) setAdmin(true);
    else alert("Wrong PIN âŒ");
  });
  btnLock.addEventListener("click", () => setAdmin(false));
  proToggle.addEventListener("change", () => {
    if(!isAdmin()){
      proToggle.checked = false;
      alert("Unlock admin first.");
      return;
    }
    setPro(proToggle.checked);
  });

  /******** DATA ********/
  const state = {
    rows: new Map(), // symbol -> row
    sortKey: "closeness",
    sortDir: 1,
    symbols: []
  };

  function getTopN(){
    const freeN = parseInt(topFreeSel.value,10) || 60;
    const proN  = parseInt(topProSel.value,10) || 200;
    return (isAdmin() && isPro()) ? proN : freeN;
  }

  function tradeUrl(sym){
    // Just open exchange page. Works for both.
    if(exchangeSel.value === "binance") return `https://www.binance.com/en/trade/${encodeURIComponent(sym.replace("USDT","_USDT"))}?type=spot`;
    return `https://www.mexc.com/exchange/${encodeURIComponent(sym)}`;
  }

  function render(){
    const q = (searchInp.value || "").trim().toUpperCase();
    const thr = Math.max(0, parseFloat(thrInp.value||"0") || 0);

    let rows = Array.from(state.rows.values()).filter(r=>{
      if(q && !r.symbol.toUpperCase().includes(q)) return false;
      return true;
    });

    rows.sort((a,b)=>{
      const k=state.sortKey, dir=state.sortDir;
      const av = isF(a[k]) ? a[k] : Infinity;
      const bv = isF(b[k]) ? b[k] : Infinity;
      return (av-bv)*dir;
    });

    const frag = document.createDocumentFragment();
    if(!rows.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="11" class="note">No rows loaded yet.</td>`;
      frag.appendChild(tr);
    } else {
      for(const r of rows){
        const near = isF(r.closeness) && r.closeness <= thr;
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${near ? "ðŸ”¥ " : ""}<strong>${r.symbol.replace("USDT","/USDT")}</strong></td>
          <td>${fmt(r.price)}</td>
          <td>${fmt(r.high)}</td>
          <td>${fmt(r.low)}</td>
          <td>${fmtPct(r.rangePct)}</td>
          <td>${fmtPct(r.toHighPct)}</td>
          <td>${fmtPct(r.toLowPct)}</td>
          <td>${isF(r.closeness)?(fmt2(r.closeness)+"%"):"â€”"}</td>
          <td>${isF(r.posPct)?(fmt2(r.posPct)+"%"):"â€”"}</td>
          <td>${proxBar(r.posPct)}</td>
          <td><a class="trade-btn" href="${tradeUrl(r.symbol)}" target="_blank" rel="noopener noreferrer">Trade</a></td>
        `;
        frag.appendChild(tr);
      }
    }
    tbody.replaceChildren(frag);
    rowCount.textContent = String(rows.length);
  }

  $$("thead th[data-k]").forEach(th=>{
    th.addEventListener("click", ()=>{
      const k=th.getAttribute("data-k");
      if(state.sortKey===k) state.sortDir *= -1;
      else { state.sortKey=k; state.sortDir=1; }
      $$("thead th").forEach(x=>x.classList.remove("sort-asc","sort-desc"));
      th.classList.add(state.sortDir===1 ? "sort-asc" : "sort-desc");
      render();
    });
  });

  function setLoadingRow(msg){
    tbody.innerHTML = `<tr><td colspan="11" class="note">${msg}</td></tr>`;
  }

  async function runPool(items, worker, max){
    let i=0;
    const runners = Array.from({length:max}, async ()=>{
      while(i<items.length){
        const idx=i++;
        await worker(items[idx], idx);
      }
    });
    await Promise.all(runners);
  }

  /******** EXCHANGE API ********/
  async function getTopSymbols_Binance(n){
    const url = "https://api.binance.com/api/v3/ticker/24hr";
    const data = await fetchJson(url);
    const usdt = data.filter(d => (d.symbol||"").endsWith("USDT") && !/UPUSDT|DOWNUSDT/.test(d.symbol));
    usdt.sort((a,b)=>(+b.quoteVolume)-(+a.quoteVolume));
    return usdt.slice(0,n).map(d=>d.symbol);
  }
  async function getPrices_Binance(){
    const url = "https://api.binance.com/api/v3/ticker/price";
    const data = await fetchJson(url);
    const map = new Map();
    for(const it of data) map.set(it.symbol, +it.price);
    return map;
  }
  async function getHL_Binance(sym, tf, istDate, istTime){
    // Fast mode (auto) => 1d candle for that day
    const {start,end} = utcWindowForIst(istDate, null);
    const ep = "https://api.binance.com/api/v3/klines";
    if(tf === "auto" || tf === "1d"){
      const url = `${ep}?symbol=${sym}&interval=1d&startTime=${start}&endTime=${end}&limit=1`;
      const a = await fetchJson(url);
      if(!Array.isArray(a)||!a.length) return null;
      return {high:+a[0][2], low:+a[0][3]};
    }
    const t = istTime || "00:00";
    const {end:targetEnd} = utcWindowForIst(istDate, t);
    const ms = intervalMsMap[tf];
    const url = `${ep}?symbol=${sym}&interval=${tf}&endTime=${targetEnd}&limit=3`;
    const arr = await fetchJson(url);
    if(!Array.isArray(arr)||!arr.length) return null;
    let chosen=null;
    for(const k of arr){
      const o=k[0];
      if(o<=targetEnd && targetEnd<o+ms){ chosen=k; break; }
    }
    if(!chosen) chosen = arr[arr.length-1];
    return {high:+chosen[2], low:+chosen[3]};
  }

  async function getTopSymbols_MEXC(n){
    // MEXC may be blocked by CORS, so we apply proxy if given
    const raw = "https://api.mexc.com/api/v3/ticker/24hr";
    const url = applyProxy(raw);
    const data = await fetchJson(url);
    const usdt = data.filter(d => (d.symbol||"").endsWith("USDT"));
    usdt.sort((a,b)=>(+b.quoteVolume)-(+a.quoteVolume));
    return usdt.slice(0,n).map(d=>d.symbol);
  }
  async function getPrices_MEXC(){
    const raw = "https://api.mexc.com/api/v3/ticker/price";
    const url = applyProxy(raw);
    const data = await fetchJson(url);
    const map = new Map();
    for(const it of data) map.set(it.symbol, +it.price);
    return map;
  }
  async function getHL_MEXC(sym, tf, istDate, istTime){
    const rawBase = "https://api.mexc.com/api/v3/klines";
    if(tf === "auto" || tf === "1d"){
      const {start,end} = utcWindowForIst(istDate, null);
      const raw = `${rawBase}?symbol=${sym}&interval=1d&startTime=${start}&endTime=${end}&limit=1`;
      const a = await fetchJson(applyProxy(raw));
      if(!Array.isArray(a)||!a.length) return null;
      return {high:+a[0][2], low:+a[0][3]};
    }
    const t = istTime || "00:00";
    const {end:targetEnd} = utcWindowForIst(istDate, t);
    const ms = intervalMsMap[tf];
    const raw = `${rawBase}?symbol=${sym}&interval=${tf}&endTime=${targetEnd}&limit=3`;
    const arr = await fetchJson(applyProxy(raw));
    if(!Array.isArray(arr)||!arr.length) return null;
    let chosen=null;
    for(const k of arr){
      const o=k[0];
      if(o<=targetEnd && targetEnd<o+ms){ chosen=k; break; }
    }
    if(!chosen) chosen = arr[arr.length-1];
    return {high:+chosen[2], low:+chosen[3]};
  }

  /******** MAIN LOAD ********/
  async function loadAll(){
    clearErr();
    const ex = exchangeSel.value;
    const istDate = dateInp.value;
    const istTime = (timeInp.value || "").trim() || null;
    const tf = tfSel.value;

    if(!istDate){
      showErr("Please select Target Date (IST).");
      return;
    }

    const n = getTopN();

    setStatus("Loading top symbols...");
    setLoadingRow("Loading top symbols...");

    let symbols = [];
    try{
      if(ex === "binance") symbols = await getTopSymbols_Binance(n);
      else symbols = await getTopSymbols_MEXC(n);
    } catch (e){
      console.error(e);
      setStatus("Error");
      if(ex === "mexc"){
        showErr(
          "MEXC blocked by browser (CORS) OR proxy not set.\n\n" +
          "Fix: choose Binance OR put a working proxy in Proxy box.\n" +
          "Also open DevTools (F12) â†’ Console to see the exact error."
        );
      } else {
        showErr("Binance API error. Check console (F12).");
      }
      setLoadingRow("Failed to load symbols (see error above).");
      return;
    }

    state.symbols = symbols;
    state.rows.clear();
    for(const s of symbols){
      state.rows.set(s, {symbol:s, price:null, high:null, low:null, toHighPct:null,toLowPct:null,posPct:null,closeness:null,rangePct:null});
    }
    render();

    setStatus("Fetching prices...");
    try{
      const pm = (ex === "binance") ? await getPrices_Binance() : await getPrices_MEXC();
      for(const s of symbols){
        const r = state.rows.get(s);
        if(r) r.price = pm.get(s) ?? null;
      }
      render();
    } catch (e){
      console.error(e);
      setStatus("Error");
      showErr("Price fetch failed. Check console (F12).");
      return;
    }

    setStatus("Fetching High/Low...");
    const concurrency = (isAdmin() && isPro()) ? 18 : 10;

    try{
      await runPool(symbols, async (sym) => {
        const r = state.rows.get(sym);
        if(!r) return;
        let hl = null;
        try{
          if(ex === "binance") hl = await getHL_Binance(sym, tf, istDate, istTime);
          else hl = await getHL_MEXC(sym, tf, istDate, istTime);
        } catch {
          hl = null;
        }
        if(hl){
          r.high = hl.high; r.low = hl.low;
          if(isF(r.price) && isF(r.high) && isF(r.low)) Object.assign(r, compute(r.price, r.high, r.low));
        }
      }, concurrency);
      render();
      setStatus("Ready");
    } catch (e){
      console.error(e);
      setStatus("Error");
      showErr("HL fetch failed. Check console (F12).");
      return;
    }
  }

  /******** EXPORT (PRO) ********/
  btnExport.addEventListener("click", () => {
    if(!(isAdmin() && isPro())){
      alert("Export is PRO. Unlock admin + enable PRO.");
      return;
    }
    const headers = ["symbol","price","high","low","rangePct","toHighPct","toLowPct","closeness","posPct"];
    const lines = [headers.join(",")];
    for(const r of state.rows.values()){
      const line = headers.map(h => {
        const v = r[h];
        if(v == null) return "";
        if(typeof v === "number") return String(v);
        return `"${String(v).replaceAll('"','""')}"`;
      }).join(",");
      lines.push(line);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "asb_scanner_export.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  /******** EVENTS ********/
  btnLoad.addEventListener("click", loadAll);
  btnRefresh.addEventListener("click", loadAll);
  searchInp.addEventListener("input", render);
  thrInp.addEventListener("input", render);

  /******** DEFAULT DATE (IST) ********/
  const IST = new Intl.DateTimeFormat("en-CA", { timeZone:"Asia/Kolkata", year:"numeric", month:"2-digit", day:"2-digit" });
  dateInp.value = IST.format(new Date());

  /******** INIT STORAGE ********/
  if(localStorage.getItem(ADMIN_KEY) !== "1") localStorage.setItem(ADMIN_KEY, "0");
  if(localStorage.getItem(PRO_KEY) !== "1") localStorage.setItem(PRO_KEY, "0");

  refreshUI();

  // Default: show content immediately (no blank)
  setStatus("Idle");
})();
</script>
</body>
</html>
